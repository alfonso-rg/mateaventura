<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MateVentura ‚Äî Aventura Matem√°tica</title>
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b0e2d;
  --card:#151a42;
  --card2:#1c2255;
  --accent:#ff6b9d;
  --accent2:#c084fc;
  --gold:#fbbf24;
  --green:#34d399;
  --blue:#60a5fa;
  --red:#f87171;
  --cyan:#22d3ee;
  --text:#e2e8f0;
  --muted:#64748b;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;position:relative;user-select:none}

/* --- Stars BG --- */
.starbg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.starbg .s{position:absolute;background:#fff;border-radius:50%;animation:tw 4s infinite ease-in-out}
@keyframes tw{0%,100%{opacity:.15}50%{opacity:.7}}

/* --- Screens --- */
.screen{display:none;flex-direction:column;height:100%;position:relative;z-index:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.screen.active{display:flex}

/* --- HUB --- */
.hub-header{text-align:center;padding:24px 16px 8px;flex-shrink:0;position:relative}
.hub-header h1{font-family:'Lilita One',cursive;font-size:2.2rem;background:linear-gradient(135deg,var(--gold),var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px}
.hub-header .sub{font-size:.85rem;color:var(--muted);margin-top:2px;font-weight:600}

.lang-selector{position:absolute;top:16px;right:16px;display:flex;gap:4px}
.lang-btn{font-size:1.3rem;width:36px;height:36px;border-radius:10px;border:2px solid rgba(255,255,255,.08);background:var(--card2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;opacity:.6}
.lang-btn.active{opacity:1;border-color:var(--accent);background:rgba(255,107,157,.15)}
.lang-btn:active{transform:scale(.9)}

.hub-stats{display:flex;justify-content:center;gap:20px;padding:8px 16px;flex-shrink:0}
.hub-stats .st{display:flex;align-items:center;gap:5px;font-size:.85rem;font-weight:700;color:var(--gold)}
.hub-stats .st span{font-size:1.1rem}

.games-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;padding:16px;flex:1;align-content:start}

.game-card{
  background:linear-gradient(145deg,var(--card),var(--card2));
  border-radius:var(--radius);border:2px solid rgba(255,255,255,.06);
  padding:18px 14px;text-align:center;cursor:pointer;
  transition:all .25s;position:relative;overflow:hidden;
  display:flex;flex-direction:column;align-items:center;gap:6px;
}
.game-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,.03));pointer-events:none}
.game-card:active{transform:scale(.95)}
.game-card .icon{font-size:2.4rem;line-height:1}
.game-card .name{font-family:'Lilita One',cursive;font-size:1rem;letter-spacing:.5px}
.game-card .desc{font-size:.7rem;color:var(--muted);font-weight:600;line-height:1.3}
.game-card .best{font-size:.65rem;color:var(--gold);font-weight:700;margin-top:2px}

.gc1{border-color:rgba(255,107,157,.2)}.gc1 .name{color:var(--accent)}
.gc2{border-color:rgba(192,132,252,.2)}.gc2 .name{color:var(--accent2)}
.gc3{border-color:rgba(52,211,153,.2)}.gc3 .name{color:var(--green)}
.gc4{border-color:rgba(96,165,250,.2)}.gc4 .name{color:var(--blue)}
.gc5{border-color:rgba(34,211,238,.2)}.gc5 .name{color:var(--cyan)}
.gc6{border-color:rgba(251,191,36,.2)}.gc6 .name{color:var(--gold)}

/* --- GAME COMMON --- */
.game-top{display:flex;align-items:center;padding:12px 16px;gap:10px;flex-shrink:0}
.back-btn{width:38px;height:38px;border-radius:12px;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:var(--text);font-size:1.2rem;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s}
.back-btn:active{transform:scale(.9)}
.game-title{font-family:'Lilita One',cursive;font-size:1.2rem;flex:1}
.game-score{font-size:.85rem;font-weight:800;color:var(--gold);white-space:nowrap}

.game-body{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 16px;overflow-y:auto}

/* --- ASTEROIDS --- */
.ast-config{width:100%;max-width:400px;margin-bottom:16px;flex-shrink:0}
.cfg-section{margin-bottom:16px}
.cfg-title{font-family:'Lilita One',cursive;font-size:.95rem;color:var(--accent);margin-bottom:8px;text-align:center}
.cfg-ops{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.cfg-op-btn{font-family:'Nunito',sans-serif;font-size:.85rem;font-weight:700;padding:10px 8px;border:2px solid rgba(255,255,255,.08);border-radius:10px;background:var(--card2);color:var(--muted);cursor:pointer;transition:all .2s}
.cfg-op-btn.active{background:linear-gradient(135deg,rgba(255,107,157,.2),rgba(192,132,252,.2));border-color:var(--accent);color:var(--text)}
.cfg-op-btn:active{transform:scale(.95)}
.cfg-btns{display:flex;gap:6px;justify-content:center}
.cfg-btn{font-family:'Nunito',sans-serif;font-size:.85rem;font-weight:700;padding:10px 14px;border:2px solid rgba(255,255,255,.08);border-radius:10px;background:var(--card2);color:var(--muted);cursor:pointer;transition:all .2s;flex:1}
.cfg-btn.active{background:linear-gradient(135deg,rgba(255,107,157,.2),rgba(192,132,252,.2));border-color:var(--accent);color:var(--text)}
.cfg-btn:active{transform:scale(.95)}

.asteroid-field{position:relative;width:100%;max-width:400px;height:320px;background:rgba(0,0,0,.3);border-radius:var(--radius);overflow:hidden;border:2px solid rgba(255,255,255,.05);flex-shrink:0;display:none}
.asteroid-field.playing{display:block}
.asteroid{position:absolute;display:flex;flex-direction:column;align-items:center;animation:fall linear forwards;pointer-events:none}
.asteroid .rock{font-size:2.2rem;line-height:1}
.asteroid .prob{font-size:.75rem;font-weight:800;background:rgba(0,0,0,.6);color:#fff;padding:2px 8px;border-radius:8px;white-space:nowrap}
@keyframes fall{0%{transform:translateY(-60px)}100%{transform:translateY(340px)}}
.ast-answers{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px;width:100%;max-width:400px}
.ast-ans{font-family:'Nunito',sans-serif;font-size:1.2rem;font-weight:800;padding:14px 0;border:none;border-radius:12px;background:var(--card2);color:var(--text);cursor:pointer;transition:all .15s;border:2px solid rgba(255,255,255,.08)}
.ast-ans:active{transform:scale(.93)}
.ast-ans.correct{background:#065f46;color:var(--green);border-color:var(--green)}
.ast-ans.wrong{background:#7f1d1d;color:var(--red);border-color:var(--red)}
.ast-lives{display:flex;gap:4px;font-size:1.1rem}
.ast-msg{font-family:'Lilita One',cursive;font-size:1.3rem;color:var(--gold);margin-top:16px;text-align:center;min-height:2rem}
.ast-start{font-family:'Lilita One',cursive;font-size:1.1rem;padding:12px 32px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;margin-top:16px;transition:all .2s}
.ast-start:active{transform:scale(.95)}

/* --- MEMORY --- */
.mem-config{width:100%;max-width:400px;margin-bottom:16px;flex-shrink:0}
.mem-grid{display:none;gap:8px;width:100%;max-width:360px}
.mem-grid.playing{display:grid}
.mem-card{
  aspect-ratio:1;border-radius:12px;font-family:'Nunito',sans-serif;font-weight:800;
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;
  font-size:1rem;border:2px solid rgba(255,255,255,.08);position:relative;
}
.mem-card.face-down{background:linear-gradient(145deg,var(--card),var(--card2));color:transparent}
.mem-card.face-down::after{content:'‚ùì';position:absolute;font-size:1.4rem}
.mem-card.face-up{background:var(--card2);color:var(--text)}
.mem-card.matched{background:#065f46;border-color:var(--green);color:var(--green)}
.mem-card:active{transform:scale(.94)}
.mem-info{display:none;gap:16px;margin-bottom:10px;font-size:.85rem;font-weight:700;color:var(--muted)}
.mem-info.playing{display:flex}

/* --- CHAIN --- */
.ch-config{width:100%;max-width:400px;margin-bottom:16px;flex-shrink:0}
.chain-display{text-align:center;margin:12px 0;display:none}
.chain-display.playing{display:block}
.chain-current{font-family:'Lilita One',cursive;font-size:3rem;color:var(--cyan);line-height:1}
.chain-target{font-size:.9rem;color:var(--muted);font-weight:700;margin-top:4px}
.chain-target b{color:var(--gold);font-size:1.1rem}
.chain-ops{display:none;grid-template-columns:repeat(2,1fr);gap:8px;width:100%;max-width:300px;margin-top:12px}
.chain-ops.playing{display:grid}
.chain-op{font-family:'Nunito',sans-serif;font-size:1.1rem;font-weight:800;padding:14px;border:none;border-radius:12px;background:var(--card2);color:var(--text);cursor:pointer;border:2px solid rgba(255,255,255,.08);transition:all .15s}
.chain-op:active{transform:scale(.93)}
.chain-op.correct{background:#065f46;border-color:var(--green);color:var(--green)}
.chain-op.wrong{background:#7f1d1d;border-color:var(--red);color:var(--red)}
.chain-history{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;justify-content:center}
.chain-step{font-size:.7rem;font-weight:700;padding:3px 8px;border-radius:8px;background:rgba(255,255,255,.06);color:var(--muted)}
.chain-timer{width:100%;max-width:300px;height:6px;border-radius:3px;background:rgba(255,255,255,.08);margin-top:10px;overflow:hidden;display:none}
.chain-timer.playing{display:block}
.chain-timer-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--gold),var(--red));transition:width .3s linear}

/* --- CROSSWORD --- */
.cw-config{width:100%;max-width:400px;margin-bottom:16px;flex-shrink:0}
.cw-grid{display:none;gap:2px}
.cw-grid.playing{display:inline-grid}
.cw-cell{display:flex;align-items:center;justify-content:center;font-family:'Lilita One',cursive;border-radius:7px;transition:all .25s}
.cw-cell.empty{background:transparent}
.cw-cell.num{background:#dbeafe;color:#1e293b;border:2px solid #bfdbfe}
.cw-cell.op{background:transparent;color:var(--muted);font-weight:700}
.cw-cell.inp{background:#fff;border:3px solid var(--accent2);color:#1e293b;cursor:pointer;animation:pulse 2s infinite}
.cw-cell.inp.filled{animation:none;border-color:#6366f1}
.cw-cell.inp.sel{animation:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,157,.25);transform:scale(1.06);z-index:2}
.cw-cell.inp.ok{animation:none;background:#bbf7d0;border-color:var(--green)}
.cw-cell.inp.bad{animation:none;background:#fecaca;border-color:var(--red)}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(192,132,252,.2)}50%{box-shadow:0 0 0 5px rgba(192,132,252,.07)}}
.cw-numpad{display:none;gap:5px;margin-top:12px;width:100%;max-width:320px}
.cw-numpad.playing{display:grid}
.cw-numpad button{font-family:'Lilita One',cursive;font-size:1.15rem;padding:8px;border:none;border-radius:10px;background:var(--card2);color:var(--text);cursor:pointer;border:2px solid rgba(255,255,255,.06);transition:all .15s}
.cw-numpad button:active{transform:scale(.92)}
.cw-numpad .cwdel{background:rgba(248,113,113,.15);color:var(--red)}
.cw-numpad .cwchk{background:rgba(52,211,153,.15);color:var(--green);font-family:'Nunito',sans-serif;font-weight:800;font-size:.85rem}

/* --- EQUATION BUILDER --- */
.eq-target{font-family:'Lilita One',cursive;font-size:1rem;color:var(--muted);text-align:center;margin:8px 0}
.eq-target b{font-size:2.2rem;color:var(--gold);display:block;margin-top:2px}
.eq-workspace{display:flex;align-items:center;justify-content:center;gap:6px;min-height:56px;padding:10px;background:rgba(255,255,255,.03);border-radius:var(--radius);border:2px dashed rgba(255,255,255,.08);width:100%;max-width:380px;flex-wrap:wrap;margin-bottom:10px}
.eq-slot{min-width:40px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Lilita One',cursive;font-size:1.2rem;padding:0 10px;cursor:pointer;transition:all .15s}
.eq-slot.num-slot{background:var(--card2);color:var(--text);border:2px solid rgba(255,255,255,.08)}
.eq-slot.op-slot{background:transparent;color:var(--accent2);font-size:1.3rem}
.eq-slot:active{transform:scale(.92)}
.eq-available{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0}
.eq-piece{font-family:'Lilita One',cursive;font-size:1.1rem;padding:10px 16px;border-radius:12px;cursor:pointer;transition:all .15s;border:2px solid rgba(255,255,255,.08)}
.eq-piece:active{transform:scale(.92)}
.eq-piece.num-piece{background:var(--card2);color:var(--text)}
.eq-piece.op-piece{background:rgba(192,132,252,.1);color:var(--accent2)}
.eq-piece.used{opacity:.3;pointer-events:none}
.eq-actions{display:flex;gap:8px;margin-top:10px}
.eq-btn{font-family:'Nunito',sans-serif;font-weight:800;font-size:.85rem;padding:10px 20px;border:none;border-radius:12px;cursor:pointer;transition:all .2s}
.eq-btn:active{transform:scale(.95)}
.eq-clear{background:rgba(248,113,113,.15);color:var(--red)}
.eq-check{background:rgba(52,211,153,.15);color:var(--green)}
.eq-hint{background:rgba(251,191,36,.15);color:var(--gold)}

/* --- NUMBER GUESS --- */
.ng-display{text-align:center;margin:16px 0}
.ng-range{font-size:.85rem;color:var(--muted);font-weight:700}
.ng-range b{color:var(--cyan)}
.ng-feedback{font-family:'Lilita One',cursive;font-size:1.3rem;min-height:2rem;margin:8px 0;text-align:center}
.ng-input-row{display:flex;gap:8px;align-items:center;justify-content:center;margin:10px 0}
.ng-input{width:100px;font-family:'Lilita One',cursive;font-size:1.5rem;text-align:center;padding:10px;border:3px solid var(--accent2);border-radius:12px;background:var(--card2);color:var(--text);outline:none}
.ng-input:focus{border-color:var(--accent)}
.ng-go{font-family:'Lilita One',cursive;font-size:1rem;padding:10px 20px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer}
.ng-go:active{transform:scale(.95)}
.ng-tries{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-top:8px}
.ng-try{font-size:.75rem;font-weight:700;padding:3px 8px;border-radius:8px}
.ng-try.hi{background:rgba(248,113,113,.15);color:var(--red)}
.ng-try.lo{background:rgba(96,165,250,.15);color:var(--blue)}

/* --- MODAL --- */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:100;align-items:center;justify-content:center;padding:20px}
.modal-ov.show{display:flex}
.modal-box{background:linear-gradient(145deg,#1e1e3a,#2a2a4a);border-radius:20px;padding:24px 18px;text-align:center;max-width:300px;width:100%;border:2px solid rgba(255,255,255,.1);animation:mpop .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes mpop{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}
.modal-box .big{font-size:3rem}
.modal-box h2{font-family:'Lilita One',cursive;font-size:1.4rem;color:var(--gold);margin:4px 0}
.modal-box p{font-size:.9rem;color:var(--muted);margin-bottom:12px}
.modal-box button{font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem;padding:10px 24px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer}
.modal-box button:active{transform:scale(.95)}

/* --- CONFETTI --- */
.confetti-box{position:fixed;inset:0;pointer-events:none;z-index:101;overflow:hidden}
.confetti{position:absolute;border-radius:2px;animation:cfall linear forwards}
@keyframes cfall{0%{transform:translateY(-20px)rotate(0);opacity:1}100%{transform:translateY(100vh)rotate(720deg);opacity:0}}

@media(max-width:380px){
  .hub-header h1{font-size:1.8rem}
  .games-grid{gap:10px;padding:12px}
  .game-card{padding:14px 10px}
  .game-card .icon{font-size:2rem}
}
</style>
</head>
<body>

<div class="starbg" id="starbg"></div>

<!-- ==================== HUB ==================== -->
<div class="screen active" id="hub-screen">
  <div class="hub-header">
    <div class="lang-selector">
      <button class="lang-btn active" data-lang="es" onclick="setLang('es')" title="Espa√±ol">üá™üá∏</button>
      <button class="lang-btn" data-lang="hu" onclick="setLang('hu')" title="Magyar">üá≠üá∫</button>
      <button class="lang-btn" data-lang="en" onclick="setLang('en')" title="English">üá¨üáß</button>
    </div>
    <h1 data-i18n="title">üöÄ MateVentura</h1>
    <div class="sub" data-i18n="subtitle">¬°Tu aventura matem√°tica espacial!</div>
  </div>
  <div class="hub-stats">
    <div class="st"><span>‚≠ê</span> <span id="hub-stars">0</span></div>
    <div class="st"><span>üî•</span> <span id="hub-streak">0</span> <span data-i18n="streak">racha</span></div>
  </div>
  <div class="games-grid">
    <div class="game-card gc1" onclick="openGame('asteroids')">
      <div class="icon">‚òÑÔ∏è</div>
      <div class="name">Asteroides</div>
      <div class="desc">¬°Destruye asteroides resolviendo operaciones!</div>
      <div class="best" id="ast-best"></div>
    </div>
    <div class="game-card gc2" onclick="openGame('memory')">
      <div class="icon">üß†</div>
      <div class="name">Memoria</div>
      <div class="desc">Empareja operaciones con sus resultados</div>
      <div class="best" id="mem-best"></div>
    </div>
    <div class="game-card gc3" onclick="openGame('chain')">
      <div class="icon">‚ö°</div>
      <div class="name">Cadena Veloz</div>
      <div class="desc">Encadena operaciones antes de que se acabe el tiempo</div>
      <div class="best" id="chain-best"></div>
    </div>
    <div class="game-card gc4" onclick="openGame('crossword')">
      <div class="icon">üî¢</div>
      <div class="name">Crucigrama</div>
      <div class="desc">Rellena la cruz num√©rica</div>
      <div class="best" id="cw-best"></div>
    </div>
    <div class="game-card gc5" onclick="openGame('equation')">
      <div class="icon">üß©</div>
      <div class="name">Constructor</div>
      <div class="desc">Construye ecuaciones con las piezas</div>
      <div class="best" id="eq-best"></div>
    </div>
    <div class="game-card gc6" onclick="openGame('guess')">
      <div class="icon">üéØ</div>
      <div class="name">Adivina</div>
      <div class="desc">Adivina el n√∫mero secreto con pistas</div>
      <div class="best" id="ng-best"></div>
    </div>
  </div>
</div>

<!-- ==================== ASTEROIDS ==================== -->
<div class="screen" id="asteroids-screen">
  <div class="game-top">
    <div class="back-btn" onclick="goHub()">‚Üê</div>
    <div class="game-title" style="color:var(--accent)">‚òÑÔ∏è Asteroides</div>
    <div class="game-score"><span class="ast-lives" id="ast-lives"></span> &nbsp;<span id="ast-score">0</span>‚≠ê</div>
  </div>
  <div class="game-body">
    <!-- CONFIG PANEL -->
    <div class="ast-config" id="ast-config">
      <div class="cfg-section">
        <div class="cfg-title">Operaciones</div>
        <div class="cfg-ops">
          <button class="cfg-op-btn active" data-op="+" onclick="astToggleOp('+')">+ Suma</button>
          <button class="cfg-op-btn active" data-op="-" onclick="astToggleOp('-')">‚àí Resta</button>
          <button class="cfg-op-btn active" data-op="√ó" onclick="astToggleOp('√ó')">√ó Multiplicaci√≥n</button>
          <button class="cfg-op-btn" data-op="√∑" onclick="astToggleOp('√∑')">√∑ Divisi√≥n</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Dificultad de n√∫meros</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-level="facil" onclick="astSetLevel('facil')">üòä F√°cil</button>
          <button class="cfg-btn active" data-level="medio" onclick="astSetLevel('medio')">ü§î Medio</button>
          <button class="cfg-btn" data-level="dificil" onclick="astSetLevel('dificil')">üî• Dif√≠cil</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Velocidad inicial</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-speed="lenta" onclick="astSetSpeed('lenta')">üê¢ Lenta</button>
          <button class="cfg-btn active" data-speed="normal" onclick="astSetSpeed('normal')">‚ö° Normal</button>
          <button class="cfg-btn" data-speed="rapida" onclick="astSetSpeed('rapida')">üöÄ R√°pida</button>
        </div>
      </div>
    </div>
    <!-- GAME AREA -->
    <div class="asteroid-field" id="ast-field"></div>
    <div class="ast-answers" id="ast-answers"></div>
    <div class="ast-msg" id="ast-msg"></div>
    <button class="ast-start" id="ast-start-btn" onclick="astStart()">¬°Empezar!</button>
  </div>
</div>

<!-- ==================== MEMORY ==================== -->
<div class="screen" id="memory-screen">
  <div class="game-top">
    <div class="back-btn" onclick="goHub()">‚Üê</div>
    <div class="game-title" style="color:var(--accent2)">üß† Memoria</div>
    <div class="game-score" id="mem-score">0 movimientos</div>
  </div>
  <div class="game-body">
    <!-- CONFIG PANEL -->
    <div class="mem-config" id="mem-config">
      <div class="cfg-section">
        <div class="cfg-title">Operaciones</div>
        <div class="cfg-ops">
          <button class="cfg-op-btn active" data-op="+" onclick="memToggleOp('+')">+ Suma</button>
          <button class="cfg-op-btn active" data-op="-" onclick="memToggleOp('-')">‚àí Resta</button>
          <button class="cfg-op-btn active" data-op="√ó" onclick="memToggleOp('√ó')">√ó Multiplicaci√≥n</button>
          <button class="cfg-op-btn" data-op="√∑" onclick="memToggleOp('√∑')">√∑ Divisi√≥n</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Tama√±o del tablero</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-size="small" onclick="memSetSize('small')">üéØ Peque√±o (12)</button>
          <button class="cfg-btn active" data-size="medium" onclick="memSetSize('medium')">üé≤ Mediano (16)</button>
          <button class="cfg-btn" data-size="large" onclick="memSetSize('large')">üé∞ Grande (20)</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Dificultad de n√∫meros</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-level="facil" onclick="memSetLevel('facil')">üòä F√°cil</button>
          <button class="cfg-btn active" data-level="medio" onclick="memSetLevel('medio')">ü§î Medio</button>
          <button class="cfg-btn" data-level="dificil" onclick="memSetLevel('dificil')">üî• Dif√≠cil</button>
        </div>
      </div>
    </div>
    <!-- GAME AREA -->
    <div class="mem-info"><span id="mem-pairs">0/0 parejas</span></div>
    <div class="mem-grid" id="mem-grid"></div>
    <button class="ast-start" id="mem-start-btn" onclick="memStart()">¬°Empezar!</button>
  </div>
</div>

<!-- ==================== CHAIN ==================== -->
<div class="screen" id="chain-screen">
  <div class="game-top">
    <div class="back-btn" onclick="goHub()">‚Üê</div>
    <div class="game-title" style="color:var(--green)">‚ö° Cadena Veloz</div>
    <div class="game-score" id="ch-score">0‚≠ê</div>
  </div>
  <div class="game-body">
    <!-- CONFIG PANEL -->
    <div class="ch-config" id="ch-config">
      <div class="cfg-section">
        <div class="cfg-title">Tiempo disponible</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-time="corto" onclick="chSetTime('corto')">‚è±Ô∏è Corto (15s)</button>
          <button class="cfg-btn active" data-time="normal" onclick="chSetTime('normal')">‚è∞ Normal (20s)</button>
          <button class="cfg-btn" data-time="largo" onclick="chSetTime('largo')">‚è≥ Largo (30s)</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Dificultad de objetivos</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-level="facil" onclick="chSetLevel('facil')">üòä F√°cil</button>
          <button class="cfg-btn active" data-level="medio" onclick="chSetLevel('medio')">ü§î Medio</button>
          <button class="cfg-btn" data-level="dificil" onclick="chSetLevel('dificil')">üî• Dif√≠cil</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Operaciones disponibles</div>
        <div class="cfg-ops">
          <button class="cfg-op-btn active" data-op="suma" onclick="chToggleOp('suma')">+ Suma</button>
          <button class="cfg-op-btn active" data-op="resta" onclick="chToggleOp('resta')">‚àí Resta</button>
          <button class="cfg-op-btn active" data-op="mult" onclick="chToggleOp('mult')">√ó Multiplicaci√≥n</button>
        </div>
      </div>
    </div>
    <!-- GAME AREA -->
    <div class="chain-timer"><div class="chain-timer-fill" id="ch-timer-fill" style="width:100%"></div></div>
    <div class="chain-display">
      <div class="chain-current" id="ch-current">5</div>
      <div class="chain-target">Llega a <b id="ch-target">20</b></div>
    </div>
    <div class="chain-ops" id="ch-ops"></div>
    <div class="chain-history" id="ch-history"></div>
    <button class="ast-start" id="ch-start-btn" onclick="chStart()">¬°Empezar!</button>
  </div>
</div>

<!-- ==================== CROSSWORD ==================== -->
<div class="screen" id="crossword-screen">
  <div class="game-top">
    <div class="back-btn" onclick="goHub()">‚Üê</div>
    <div class="game-title" style="color:var(--blue)">üî¢ Crucigrama</div>
    <div class="game-score" id="cw-score">0‚≠ê</div>
  </div>
  <div class="game-body">
    <!-- CONFIG PANEL -->
    <div class="cw-config" id="cw-config">
      <div class="cfg-section">
        <div class="cfg-title">Dificultad</div>
        <div class="cfg-btns">
          <button class="cfg-btn" data-level="facil" onclick="cwSetLevel('facil')">üòä F√°cil</button>
          <button class="cfg-btn active" data-level="medio" onclick="cwSetLevel('medio')">ü§î Medio</button>
          <button class="cfg-btn" data-level="dificil" onclick="cwSetLevel('dificil')">üî• Dif√≠cil</button>
        </div>
      </div>
      <div class="cfg-section">
        <div class="cfg-title">Tama√±o del crucigrama</div>
        <div class="cfg-btns">
          <button class="cfg-btn active" data-size="small" onclick="cwSetSize('small')">üìã Cruz</button>
          <button class="cfg-btn" data-size="medium" onclick="cwSetSize('medium')">üìä Doble</button>
          <button class="cfg-btn" data-size="large" onclick="cwSetSize('large')">üìà Grande</button>
        </div>
      </div>
    </div>
    <!-- GAME AREA -->
    <div class="cw-grid" id="cw-grid"></div>
    <div class="cw-numpad" id="cw-numpad"></div>
    <div style="display:flex;gap:8px;margin-top:8px;padding-bottom:12px">
      <button class="eq-btn eq-hint" onclick="cwHint()">üí° Pista</button>
      <button class="eq-btn eq-check" onclick="cwNew()">üé≤ Nuevo</button>
    </div>
    <button class="ast-start" id="cw-start-btn" onclick="cwStartGame()">¬°Empezar!</button>
  </div>
</div>

<!-- ==================== EQUATION BUILDER ==================== -->
<div class="screen" id="equation-screen">
  <div class="game-top">
    <div class="back-btn" onclick="goHub()">‚Üê</div>
    <div class="game-title" style="color:var(--cyan)">üß© Constructor</div>
    <div class="game-score" id="eqb-score">0‚≠ê</div>
  </div>
  <div class="game-body">
    <div class="eq-target">Construye una ecuaci√≥n que d√©:<b id="eqb-target">12</b></div>
    <div class="eq-workspace" id="eqb-workspace"></div>
    <div class="eq-available" id="eqb-pieces"></div>
    <div class="eq-actions">
      <button class="eq-btn eq-clear" onclick="eqbClear()">üóëÔ∏è Limpiar</button>
      <button class="eq-btn eq-check" onclick="eqbCheck()">‚úì Comprobar</button>
      <button class="eq-btn eq-hint" onclick="eqbSkip()">‚è≠Ô∏è Saltar</button>
    </div>
  </div>
</div>

<!-- ==================== NUMBER GUESS ==================== -->
<div class="screen" id="guess-screen">
  <div class="game-top">
    <div class="back-btn" onclick="goHub()">‚Üê</div>
    <div class="game-title" style="color:var(--gold)">üéØ Adivina</div>
    <div class="game-score" id="ng-score">0‚≠ê</div>
  </div>
  <div class="game-body">
    <div class="ng-display">
      <div class="ng-range">N√∫mero entre <b id="ng-lo">1</b> y <b id="ng-hi">50</b></div>
    </div>
    <div class="ng-feedback" id="ng-fb"></div>
    <div class="ng-input-row">
      <input type="number" class="ng-input" id="ng-input" min="1">
      <button class="ng-go" onclick="ngGuess()">‚Üí</button>
    </div>
    <div class="ng-tries" id="ng-tries"></div>
  </div>
</div>

<!-- ==================== MODAL ==================== -->
<div class="modal-ov" id="modal">
  <div class="modal-box">
    <div class="big" id="m-icon">üéâ</div>
    <h2 id="m-title">¬°Genial!</h2>
    <p id="m-text">Texto</p>
    <button id="m-btn" onclick="modalAction()">Siguiente</button>
  </div>
</div>
<div class="confetti-box" id="confetti"></div>

<script>
"use strict";

/* ============================
   I18N - TRANSLATIONS
   ============================ */
const translations = {
  es: {
    title: 'üöÄ MateVentura',
    subtitle: '¬°Tu aventura matem√°tica espacial!',
    streak: 'racha',
    start: '¬°Empezar!',
    operations: 'Operaciones',
    addition: '+ Suma',
    subtraction: '‚àí Resta',
    multiplication: '√ó Multiplicaci√≥n',
    division: '√∑ Divisi√≥n',
    difficulty: 'Dificultad de n√∫meros',
    easy: 'üòä F√°cil',
    medium: 'ü§î Medio',
    hard: 'üî• Dif√≠cil',
    speed: 'Velocidad inicial',
    slow: 'üê¢ Lenta',
    normal: '‚ö° Normal',
    fast: 'üöÄ R√°pida',
    boardSize: 'Tama√±o del tablero',
    small: 'üéØ Peque√±o (12)',
    mediumSize: 'üé≤ Mediano (16)',
    large: 'üé∞ Grande (20)',
    timeAvailable: 'Tiempo disponible',
    short: '‚è±Ô∏è Corto (15s)',
    normalTime: '‚è∞ Normal (20s)',
    long: '‚è≥ Largo (30s)',
    targetDifficulty: 'Dificultad de objetivos',
    availableOps: 'Operaciones disponibles',
    crosswordDiff: 'Dificultad',
    crosswordSize: 'Tama√±o del crucigrama',
    cross: 'üìã Cruz',
    double: 'üìä Doble',
    big: 'üìà Grande',
    configAndStart: 'Configura y pulsa ¬°Empezar!',
    movements: 'movimientos',
    pairs: 'parejas',
    asteroids: 'Asteroides',
    asteroidsDesc: '¬°Destruye asteroides resolviendo operaciones!',
    memory: 'Memoria',
    memoryDesc: 'Empareja operaciones con sus resultados',
    chain: 'Cadena Veloz',
    chainDesc: 'Encadena operaciones antes de que se acabe el tiempo',
    crossword: 'Crucigrama',
    crosswordDesc: 'Rellena la cruz num√©rica',
    builder: 'Constructor',
    builderDesc: 'Construye ecuaciones con las piezas',
    guess: 'Adivina',
    guessDesc: 'Adivina el n√∫mero secreto con pistas'
  },
  en: {
    title: 'üöÄ MathVenture',
    subtitle: 'Your space math adventure!',
    streak: 'streak',
    start: 'Start!',
    operations: 'Operations',
    addition: '+ Addition',
    subtraction: '‚àí Subtraction',
    multiplication: '√ó Multiplication',
    division: '√∑ Division',
    difficulty: 'Number difficulty',
    easy: 'üòä Easy',
    medium: 'ü§î Medium',
    hard: 'üî• Hard',
    speed: 'Initial speed',
    slow: 'üê¢ Slow',
    normal: '‚ö° Normal',
    fast: 'üöÄ Fast',
    boardSize: 'Board size',
    small: 'üéØ Small (12)',
    mediumSize: 'üé≤ Medium (16)',
    large: 'üé∞ Large (20)',
    timeAvailable: 'Available time',
    short: '‚è±Ô∏è Short (15s)',
    normalTime: '‚è∞ Normal (20s)',
    long: '‚è≥ Long (30s)',
    targetDifficulty: 'Target difficulty',
    availableOps: 'Available operations',
    crosswordDiff: 'Difficulty',
    crosswordSize: 'Crossword size',
    cross: 'üìã Cross',
    double: 'üìä Double',
    big: 'üìà Large',
    configAndStart: 'Configure and press Start!',
    movements: 'moves',
    pairs: 'pairs',
    asteroids: 'Asteroids',
    asteroidsDesc: 'Destroy asteroids by solving operations!',
    memory: 'Memory',
    memoryDesc: 'Match operations with their results',
    chain: 'Fast Chain',
    chainDesc: 'Chain operations before time runs out',
    crossword: 'Crossword',
    crosswordDesc: 'Fill the number cross',
    builder: 'Builder',
    builderDesc: 'Build equations with the pieces',
    guess: 'Guess',
    guessDesc: 'Guess the secret number with clues'
  },
  hu: {
    title: 'üöÄ MatekKaland',
    subtitle: '≈∞rbeli matematikai kalandod!',
    streak: 'sorozat',
    start: 'Kezd√©s!',
    operations: 'M≈±veletek',
    addition: '+ √ñsszead√°s',
    subtraction: '‚àí Kivon√°s',
    multiplication: '√ó Szorz√°s',
    division: '√∑ Oszt√°s',
    difficulty: 'Sz√°mok neh√©zs√©ge',
    easy: 'üòä K√∂nny≈±',
    medium: 'ü§î K√∂zepes',
    hard: 'üî• Neh√©z',
    speed: 'Kezd≈ë sebess√©g',
    slow: 'üê¢ Lass√∫',
    normal: '‚ö° Norm√°l',
    fast: 'üöÄ Gyors',
    boardSize: 'T√°bla m√©rete',
    small: 'üéØ Kicsi (12)',
    mediumSize: 'üé≤ K√∂zepes (16)',
    large: 'üé∞ Nagy (20)',
    timeAvailable: 'Rendelkez√©sre √°ll√≥ id≈ë',
    short: '‚è±Ô∏è R√∂vid (15mp)',
    normalTime: '‚è∞ Norm√°l (20mp)',
    long: '‚è≥ Hossz√∫ (30mp)',
    targetDifficulty: 'C√©l neh√©zs√©ge',
    availableOps: 'El√©rhet≈ë m≈±veletek',
    crosswordDiff: 'Neh√©zs√©g',
    crosswordSize: 'Keresztrejtv√©ny m√©rete',
    cross: 'üìã Kereszt',
    double: 'üìä Dupla',
    big: 'üìà Nagy',
    configAndStart: '√Åll√≠tsd be √©s nyomd meg a Kezd√©s!',
    movements: 'l√©p√©s',
    pairs: 'p√°r',
    asteroids: 'Aszteroid√°k',
    asteroidsDesc: 'Puszt√≠tsd el az aszteroid√°kat m≈±veletek megold√°s√°val!',
    memory: 'Mem√≥ria',
    memoryDesc: 'P√°ros√≠tsd a m≈±veleteket az eredm√©nyekkel',
    chain: 'Gyors L√°nc',
    chainDesc: 'L√°ncolj m≈±veleteket, miel≈ëtt lej√°r az id≈ë',
    crossword: 'Keresztrejtv√©ny',
    crosswordDesc: 'T√∂ltsd ki a sz√°mos keresztet',
    builder: '√âp√≠t≈ë',
    builderDesc: '√âp√≠ts egyenleteket a darabokb√≥l',
    guess: 'Tal√°ld ki',
    guessDesc: 'Tal√°ld ki a titkos sz√°mot tippekkel'
  }
};

let currentLang = 'es';
try {
  const saved = localStorage.getItem('mv_lang');
  if (saved && translations[saved]) currentLang = saved;
} catch(e) {}

function t(key) {
  return translations[currentLang][key] || translations['es'][key] || key;
}

function setLang(lang) {
  if (!translations[lang]) return;
  currentLang = lang;
  try { localStorage.setItem('mv_lang', lang); } catch(e) {}

  // Update lang buttons
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  // Update all i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    el.textContent = t(key);
  });

  // Update dynamic content
  updateLangContent();
}

function updateLangContent() {
  // Update hub game cards
  const gameCards = [
    {name: 'asteroids', desc: 'asteroidsDesc'},
    {name: 'memory', desc: 'memoryDesc'},
    {name: 'chain', desc: 'chainDesc'},
    {name: 'crossword', desc: 'crosswordDesc'},
    {name: 'builder', desc: 'builderDesc'},
    {name: 'guess', desc: 'guessDesc'}
  ];

  document.querySelectorAll('.game-card').forEach((card, i) => {
    if (i < gameCards.length) {
      const nameEl = card.querySelector('.name');
      const descEl = card.querySelector('.desc');
      if (nameEl) nameEl.textContent = t(gameCards[i].name);
      if (descEl) descEl.textContent = t(gameCards[i].desc);
    }
  });

  // Update config panels
  document.querySelectorAll('.cfg-title').forEach(el => {
    const text = el.textContent;
    if (text.includes('Operaciones') || text.includes('Operations') || text.includes('M≈±veletek')) el.textContent = t('operations');
    if (text.includes('Dificultad de n√∫meros') || text.includes('Number difficulty') || text.includes('Sz√°mok neh√©zs√©ge')) el.textContent = t('difficulty');
    if (text.includes('Velocidad') || text.includes('speed') || text.includes('sebess√©g')) el.textContent = t('speed');
    if (text.includes('Tama√±o del tablero') || text.includes('Board size') || text.includes('T√°bla m√©rete')) el.textContent = t('boardSize');
    if (text.includes('Tiempo') || text.includes('time') || text.includes('id≈ë')) el.textContent = t('timeAvailable');
    if (text.includes('objetivos') || text.includes('Target') || text.includes('C√©l')) el.textContent = t('targetDifficulty');
    if (text.includes('disponibles') || text.includes('Available') || text.includes('El√©rhet≈ë')) el.textContent = t('availableOps');
    if (text.includes('crucigrama') || text.includes('Crossword') || text.includes('Keresztrejtv√©ny')) el.textContent = t('crosswordSize');
    if (text === 'Dificultad' || text === 'Difficulty' || text === 'Neh√©zs√©g') el.textContent = t('crosswordDiff');
  });

  // Update config buttons
  document.querySelectorAll('.cfg-op-btn, .cfg-btn').forEach(btn => {
    const text = btn.textContent;
    if (text.includes('Suma') || text.includes('Addition') || text.includes('√ñsszead√°s')) btn.textContent = t('addition');
    if (text.includes('Resta') || text.includes('Subtraction') || text.includes('Kivon√°s')) btn.textContent = t('subtraction');
    if (text.includes('Multiplicaci√≥n') || text.includes('Multiplication') || text.includes('Szorz√°s')) btn.textContent = t('multiplication');
    if (text.includes('Divisi√≥n') || text.includes('Division') || text.includes('Oszt√°s')) btn.textContent = t('division');
    if (text.includes('F√°cil') || text.includes('Easy') || text.includes('K√∂nny≈±')) btn.textContent = t('easy');
    if (text.includes('Medio') || text.includes('Medium') || text.includes('K√∂zepes')) btn.textContent = t('medium');
    if (text.includes('Dif√≠cil') || text.includes('Hard') || text.includes('Neh√©z')) btn.textContent = t('hard');
    if (text.includes('Lenta') || text.includes('Slow') || text.includes('Lass√∫')) btn.textContent = t('slow');
    if (text.includes('R√°pida') || text.includes('Fast') || text.includes('Gyors')) btn.textContent = t('fast');
    if (text.includes('Peque√±o') || text.includes('Small') || text.includes('Kicsi')) btn.textContent = t('small');
    if (text.includes('Mediano (16)') || text.includes('Medium (16)') || text.includes('K√∂zepes (16)')) btn.textContent = t('mediumSize');
    if (text.includes('Grande (20)') || text.includes('Large (20)') || text.includes('Nagy (20)')) btn.textContent = t('large');
    if (text.includes('Corto') || text.includes('Short') || text.includes('R√∂vid')) btn.textContent = t('short');
    if (text.includes('Largo') || text.includes('Long') || text.includes('Hossz√∫')) btn.textContent = t('long');
    if (text.includes('Cruz') || text.includes('Cross') || text.includes('Kereszt')) btn.textContent = t('cross');
    if (text.includes('Doble') || text.includes('Double') || text.includes('Dupla')) btn.textContent = t('double');
    if (text.includes('Grande') && text.includes('üìà') || text.includes('Large') && text.includes('üìà') || text.includes('Nagy') && text.includes('üìà')) btn.textContent = t('big');
    if (text.includes('Normal') && (text.includes('‚ö°') || text.includes('‚è∞'))) {
      if (text.includes('‚ö°')) btn.textContent = t('normal');
      else btn.textContent = t('normalTime');
    }
  });

  // Update start buttons
  document.querySelectorAll('.ast-start').forEach(btn => {
    btn.textContent = t('start');
  });

  // Update messages
  if ($('ast-msg')) $('ast-msg').textContent = t('configAndStart');
}

/* ============================
   GLOBALS
   ============================ */
const $=id=>document.getElementById(id);
const R=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const shuffle=a=>{const r=[...a];for(let i=r.length-1;i>0;i--){const j=R(0,i);[r[i],r[j]]=[r[j],r[i]]}return r};

let stars=0, streakG=0;
try{stars=+(localStorage.getItem('mv_s')||0);streakG=+(localStorage.getItem('mv_k')||0)}catch(e){}
function addStars(n){stars+=n;streakG++;try{localStorage.setItem('mv_s',stars);localStorage.setItem('mv_k',streakG)}catch(e){}$('hub-stars').textContent=stars;$('hub-streak').textContent=streakG}
function resetStreak(){streakG=0;try{localStorage.setItem('mv_k',0)}catch(e){}$('hub-streak').textContent=0}
$('hub-stars').textContent=stars;$('hub-streak').textContent=streakG;

// Stars BG
(function(){const c=$('starbg');for(let i=0;i<50;i++){const s=document.createElement('div');s.className='s';s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2.5+.5}px;height:${Math.random()*2.5+.5}px;animation-delay:${Math.random()*4}s;animation-duration:${R(3,6)}s`;c.appendChild(s)}})();

// Initialize language
setLang(currentLang);

/* ============================
   NAVIGATION
   ============================ */
let currentGame=null, modalCb=null;
function openGame(g){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(g+'-screen').classList.add('active');currentGame=g;initGame(g)}
function goHub(){
  if(currentGame==='asteroids')astStop();
  if(currentGame==='chain')chStop();
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$('hub-screen').classList.add('active');currentGame=null;
}
function initGame(g){({asteroids:astInit,memory:memInit,chain:chInit,crossword:cwInit,equation:eqbInit,guess:ngInit})[g]()}

function showModal(icon,title,text,btnText,cb){$('m-icon').textContent=icon;$('m-title').textContent=title;$('m-text').textContent=text;$('m-btn').textContent=btnText;modalCb=cb;$('modal').classList.add('show')}
function modalAction(){$('modal').classList.remove('show');if(modalCb)modalCb()}
function confetti(){const c=$('confetti');c.innerHTML='';const cols=['#e94560','#ffd700','#34d399','#60a5fa','#c084fc','#fb923c','#f472b6','#22d3ee'];for(let i=0;i<50;i++){const p=document.createElement('div');p.className='confetti';p.style.cssText=`left:${Math.random()*100}%;top:-10px;background:${cols[R(0,cols.length-1)]};width:${R(5,12)}px;height:${R(5,12)}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${(Math.random()*2+1.5).toFixed(1)}s;animation-delay:${(Math.random()*.5).toFixed(2)}s`;c.appendChild(p)}setTimeout(()=>c.innerHTML='',4000)}

/* ============================
   1. ASTEROIDS
   ============================ */
let astTimer=null,astScore=0,astLives=0,astSpeed=4000,astActive=false,astCurrent=null;
let astConfig={ops:['+','-','√ó'],level:'medio',speed:'normal'};

function astToggleOp(op){
  const btn=document.querySelector(`.cfg-op-btn[data-op="${op}"]`);
  if(btn.classList.contains('active')){
    if(astConfig.ops.length>1){astConfig.ops=astConfig.ops.filter(o=>o!==op);btn.classList.remove('active')}
  }else{astConfig.ops.push(op);btn.classList.add('active')}
}

function astSetLevel(lv){
  astConfig.level=lv;
  document.querySelectorAll('.cfg-btn[data-level]').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.cfg-btn[data-level="${lv}"]`).classList.add('active');
}

function astSetSpeed(sp){
  astConfig.speed=sp;
  document.querySelectorAll('.cfg-btn[data-speed]').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.cfg-btn[data-speed="${sp}"]`).classList.add('active');
}

function astInit(){
  astScore=0;astLives=3;
  // Set initial speed based on config - m√°s diferencia notable
  astSpeed=astConfig.speed==='lenta'?6500:astConfig.speed==='normal'?4000:2500;
  $('ast-score').textContent='0';astRenderLives();
  $('ast-field').innerHTML='';$('ast-field').classList.remove('playing');
  $('ast-answers').innerHTML='';
  $('ast-msg').textContent='Configura y pulsa ¬°Empezar!';
  $('ast-start-btn').style.display='';
  $('ast-config').style.display='';
  astActive=false;
}

function astRenderLives(){let h='';for(let i=0;i<3;i++)h+=i<astLives?'‚ù§Ô∏è':'üñ§';$('ast-lives').innerHTML=h}

function astStart(){
  $('ast-start-btn').style.display='none';
  $('ast-config').style.display='none';
  $('ast-field').classList.add('playing');
  $('ast-msg').textContent='';
  astActive=true;
  astNext();
}

function astStop(){astActive=false;if(astTimer)clearTimeout(astTimer);$('ast-field').innerHTML='';$('ast-field').classList.remove('playing')}

function astNext(){
  if(!astActive)return;
  // Generate problem based on config
  const op=astConfig.ops[R(0,astConfig.ops.length-1)];
  let a,b,answer;

  // Difficulty ranges
  const ranges={
    facil:{sum:[1,10],sub:[5,15],mul:[2,5],div:[2,5]},
    medio:{sum:[5,20],sub:[10,30],mul:[2,9],div:[2,10]},
    dificil:{sum:[10,50],sub:[20,60],mul:[3,12],div:[3,12]}
  };
  const r=ranges[astConfig.level];

  if(op==='+'){a=R(r.sum[0],r.sum[1]);b=R(r.sum[0],r.sum[1]);answer=a+b}
  else if(op==='-'){const mx=r.sub[1];a=R(r.sub[0],mx);b=R(r.sub[0],Math.min(a-1,mx));answer=a-b}
  else if(op==='√ó'){a=R(r.mul[0],r.mul[1]);b=R(r.mul[0],r.mul[1]);answer=a*b}
  else{b=R(r.div[0],r.div[1]);const q=R(r.div[0],r.div[1]);a=b*q;answer=q}

  const problem=`${a} ${op} ${b}`;
  astCurrent={answer,el:null};

  // Create asteroid
  const ast=document.createElement('div');ast.className='asteroid';
  ast.style.left=R(10,70)+'%';ast.style.animationDuration=(astSpeed)+'ms';
  ast.innerHTML=`<div class="rock">‚òÑÔ∏è</div><div class="prob">${problem}</div>`;
  $('ast-field').appendChild(ast);
  astCurrent.el=ast;

  // Answers
  const wrong1=answer+R(1,5)*(Math.random()>.5?1:-1);
  const wrong2=answer+R(1,8)*(Math.random()>.5?1:-1);
  let opts=shuffle([answer,wrong1===answer?answer+3:wrong1,wrong2===answer||wrong2===wrong1?answer-2:wrong2]);
  if(opts.some(v=>v<0))opts=opts.map(v=>Math.abs(v));
  const ans=$('ast-answers');ans.innerHTML='';
  opts.forEach(v=>{const b=document.createElement('button');b.className='ast-ans';b.textContent=v;b.onclick=()=>astAnswer(v,b);ans.appendChild(b)});

  // Timeout
  astTimer=setTimeout(()=>{
    if(!astActive)return;
    ast.remove();astLives--;astRenderLives();
    if(astLives<=0){astGameOver()}else{astNext()}
  },astSpeed);

  ast.addEventListener('animationend',()=>ast.remove());
}

function astAnswer(v,btn){
  if(!astActive||!astCurrent)return;
  clearTimeout(astTimer);
  if(v===astCurrent.answer){
    btn.classList.add('correct');
    astCurrent.el.remove();astScore++;$('ast-score').textContent=astScore;
    // Speed up based on initial speed - velocidades m√≠nimas m√°s acordes
    const minSpeed=astConfig.speed==='lenta'?3000:astConfig.speed==='normal'?1800:1200;
    if(astSpeed>minSpeed)astSpeed-=120;
    setTimeout(()=>{if(astActive)astNext()},400);
  }else{
    btn.classList.add('wrong');astLives--;astRenderLives();
    if(astLives<=0){setTimeout(astGameOver,300)}
    else{setTimeout(()=>{if(astActive)astNext()},600)}
  }
}

function astGameOver(){
  astActive=false;$('ast-field').innerHTML='';$('ast-answers').innerHTML='';
  const earned=astScore;addStars(earned);
  confetti();showModal('‚òÑÔ∏è','¬°Fin de la misi√≥n!',`Destruiste ${astScore} asteroides.\n+${earned}‚≠ê`,'Jugar de nuevo',astInit);
}

/* ============================
   2. MEMORY
   ============================ */
let memCards=[],memFlipped=[],memMatched=0,memTotal=0,memMoves=0,memLocked=false;
let memConfig={ops:['+','-','√ó'],size:'medium',level:'medio'};

function memToggleOp(op){
  const btn=$('mem-config').querySelector(`.cfg-op-btn[data-op="${op}"]`);
  if(btn.classList.contains('active')){
    if(memConfig.ops.length>1){memConfig.ops=memConfig.ops.filter(o=>o!==op);btn.classList.remove('active')}
  }else{memConfig.ops.push(op);btn.classList.add('active')}
}

function memSetSize(sz){
  memConfig.size=sz;
  $('mem-config').querySelectorAll('.cfg-btn[data-size]').forEach(b=>b.classList.remove('active'));
  $('mem-config').querySelector(`.cfg-btn[data-size="${sz}"]`).classList.add('active');
}

function memSetLevel(lv){
  memConfig.level=lv;
  $('mem-config').querySelectorAll('.cfg-btn[data-level]').forEach(b=>b.classList.remove('active'));
  $('mem-config').querySelector(`.cfg-btn[data-level="${lv}"]`).classList.add('active');
}

function memInit(){
  memMatched=0;memMoves=0;memLocked=false;
  $('mem-score').textContent='0 movimientos';
  $('mem-grid').classList.remove('playing');
  $('mem-grid').innerHTML='';
  $('mem-info').classList.remove('playing');
  $('mem-config').style.display='';
  $('mem-start-btn').style.display='';
}

function memStart(){
  $('mem-config').style.display='none';
  $('mem-start-btn').style.display='none';
  $('mem-grid').classList.add('playing');
  $('mem-info').classList.add('playing');

  // Generate pairs based on config
  const pairCount=memConfig.size==='small'?6:memConfig.size==='medium'?8:10;
  const ranges={
    facil:{sum:[1,10],sub:[5,15],mul:[2,5],div:[2,5]},
    medio:{sum:[1,12],sub:[5,20],mul:[2,9],div:[2,10]},
    dificil:{sum:[5,25],sub:[10,40],mul:[3,12],div:[3,12]}
  };
  const r=ranges[memConfig.level];

  const pairs=[];
  for(let i=0;i<pairCount;i++){
    const op=memConfig.ops[R(0,memConfig.ops.length-1)];
    let a,b,ans;
    if(op==='+'){a=R(r.sum[0],r.sum[1]);b=R(r.sum[0],r.sum[1]);ans=a+b}
    else if(op==='-'){const mx=r.sub[1];a=R(r.sub[0],mx);b=R(r.sub[0],Math.min(a-1,mx));ans=a-b}
    else if(op==='√ó'){a=R(r.mul[0],r.mul[1]);b=R(r.mul[0],r.mul[1]);ans=a*b}
    else{b=R(r.div[0],r.div[1]);const q=R(r.div[0],r.div[1]);a=b*q;ans=q}
    pairs.push({q:`${a} ${op} ${b}`,a:String(ans),id:i});
  }

  memTotal=pairs.length;
  memCards=shuffle([...pairs.map(p=>({text:p.q,id:p.id,type:'q'})),...pairs.map(p=>({text:p.a,id:p.id,type:'a'}))]);
  memFlipped=[];
  $('mem-pairs').textContent=`0/${memTotal} parejas`;

  const g=$('mem-grid');g.innerHTML='';
  const cols=memConfig.size==='small'?4:memConfig.size==='medium'?4:5;
  g.style.gridTemplateColumns=`repeat(${cols},1fr)`;

  memCards.forEach((c,i)=>{
    const d=document.createElement('div');
    d.className='mem-card face-down';d.dataset.idx=i;
    d.addEventListener('click',()=>memFlip(i,d));g.appendChild(d);
  });
}

function memFlip(i,el){
  if(memLocked||el.classList.contains('face-up')||el.classList.contains('matched'))return;
  el.classList.remove('face-down');el.classList.add('face-up');el.textContent=memCards[i].text;
  memFlipped.push({i,el});
  if(memFlipped.length===2){
    memMoves++;$('mem-score').textContent=memMoves+' movimientos';
    memLocked=true;
    const[a,b]=memFlipped;
    if(memCards[a.i].id===memCards[b.i].id && a.i!==b.i){
      setTimeout(()=>{a.el.classList.add('matched');b.el.classList.add('matched');memMatched++;$('mem-pairs').textContent=`${memMatched}/${memTotal} parejas`;memFlipped=[];memLocked=false;
        if(memMatched===memTotal){const earned=Math.max(1,6-Math.floor(memMoves/6));addStars(earned);confetti();showModal('üß†','¬°Memoria perfecta!',`Lo lograste en ${memMoves} movimientos.\n+${earned}‚≠ê`,'Jugar de nuevo',memInit)}
      },400);
    }else{
      setTimeout(()=>{a.el.classList.remove('face-up');a.el.classList.add('face-down');a.el.textContent='';b.el.classList.remove('face-up');b.el.classList.add('face-down');b.el.textContent='';memFlipped=[];memLocked=false},800);
    }
  }
}

/* ============================
   3. CHAIN
   ============================ */
let chCurrent=0,chTarget=0,chScore=0,chTimeLeft=0,chMaxTime=20000,chInterval=null,chActive=false;
let chConfig={time:'normal',level:'medio',ops:['suma','resta','mult']};

function chToggleOp(op){
  const btn=$('ch-config').querySelector(`.cfg-op-btn[data-op="${op}"]`);
  if(btn.classList.contains('active')){
    if(chConfig.ops.length>1){chConfig.ops=chConfig.ops.filter(o=>o!==op);btn.classList.remove('active')}
  }else{chConfig.ops.push(op);btn.classList.add('active')}
}

function chSetTime(tm){
  chConfig.time=tm;
  $('ch-config').querySelectorAll('.cfg-btn[data-time]').forEach(b=>b.classList.remove('active'));
  $('ch-config').querySelector(`.cfg-btn[data-time="${tm}"]`).classList.add('active');
}

function chSetLevel(lv){
  chConfig.level=lv;
  $('ch-config').querySelectorAll('.cfg-btn[data-level]').forEach(b=>b.classList.remove('active'));
  $('ch-config').querySelector(`.cfg-btn[data-level="${lv}"]`).classList.add('active');
}

function chInit(){
  chScore=0;$('ch-score').textContent='0‚≠ê';chActive=false;
  $('ch-config').style.display='';
  $('ch-start-btn').style.display='';
  document.querySelector('.chain-timer').classList.remove('playing');
  $('ch-ops').classList.remove('playing');
  document.querySelector('.chain-display').classList.remove('playing');
  $('ch-history').innerHTML='';
}

function chStart(){
  $('ch-config').style.display='none';
  $('ch-start-btn').style.display='none';
  document.querySelector('.chain-timer').classList.add('playing');
  $('ch-ops').classList.add('playing');
  document.querySelector('.chain-display').classList.add('playing');
  chMaxTime=chConfig.time==='corto'?15000:chConfig.time==='normal'?20000:30000;
  chNewRound();
}

function chNewRound(){
  const ranges={facil:{start:[1,5],diff:[5,15]},medio:{start:[1,10],diff:[10,25]},dificil:{start:[5,20],diff:[20,50]}};
  const r=ranges[chConfig.level];
  chCurrent=R(r.start[0],r.start[1]);
  chTarget=R(chCurrent+r.diff[0],chCurrent+r.diff[1]);
  $('ch-current').textContent=chCurrent;$('ch-target').textContent=chTarget;
  $('ch-history').innerHTML='';chTimeLeft=chMaxTime;
  chRenderOps();chStartTimer();chActive=true;
}

function chStartTimer(){
  if(chInterval)clearInterval(chInterval);
  const start=Date.now();
  $('ch-timer-fill').style.width='100%';
  chInterval=setInterval(()=>{
    const elapsed=Date.now()-start;
    const pct=Math.max(0,1-elapsed/chMaxTime)*100;
    $('ch-timer-fill').style.width=pct+'%';
    if(elapsed>=chMaxTime){chStop();resetStreak();showModal('‚è∞','¬°Tiempo!',`Conseguiste ${chScore}‚≠ê antes de que se acabara el tiempo.`,'Reintentar',chInit)}
  },50);
}
function chStop(){chActive=false;if(chInterval){clearInterval(chInterval);chInterval=null}}

function chRenderOps(){
  const ops=$('ch-ops');ops.innerHTML='';
  const options=[];
  const diff=chTarget-chCurrent;

  // Generate options based on enabled operations
  const canUse={suma:chConfig.ops.includes('suma'),resta:chConfig.ops.includes('resta'),mult:chConfig.ops.includes('mult')};

  // Always include at least one that gets closer
  if(diff>0 && canUse.suma){
    if(diff<=10)options.push({label:`+ ${diff}`,fn:v=>v+diff});
    else{const step=R(1,Math.min(diff,10));options.push({label:`+ ${step}`,fn:v=>v+step})}
  }
  if(canUse.mult){
    const m=R(2,5);if(chCurrent*m<=chTarget+10)options.push({label:`√ó ${m}`,fn:v=>v*m});
  }

  // Fill rest with enabled operations
  while(options.length<4){
    const availTypes=[];
    if(canUse.suma)availTypes.push('suma');
    if(canUse.resta)availTypes.push('resta');
    if(canUse.mult)availTypes.push('mult');
    const type=availTypes[R(0,availTypes.length-1)];

    if(type==='suma'){const n=R(1,10);options.push({label:`+ ${n}`,fn:v=>v+n})}
    else if(type==='resta'){const n=R(1,Math.max(1,chCurrent-1));if(chCurrent-n>=0)options.push({label:`- ${n}`,fn:v=>v-n})}
    else if(type==='mult'){const n=R(2,5);options.push({label:`√ó ${n}`,fn:v=>v*n})}
  }
  shuffle(options).slice(0,4).forEach(op=>{
    const b=document.createElement('button');b.className='chain-op';b.textContent=op.label;
    b.onclick=()=>{
      if(!chActive)return;
      const nv=op.fn(chCurrent);
      const step=document.createElement('span');step.className='chain-step';step.textContent=`${chCurrent} ${op.label} = ${nv}`;$('ch-history').appendChild(step);
      chCurrent=nv;$('ch-current').textContent=chCurrent;
      if(chCurrent===chTarget){
        chActive=false;clearInterval(chInterval);chScore++;$('ch-score').textContent=chScore+'‚≠ê';
        b.classList.add('correct');
        setTimeout(()=>{addStars(1);chNewRound()},600);
      }else if(chCurrent>chTarget*2||chCurrent<0){
        b.classList.add('wrong');chActive=false;clearInterval(chInterval);
        setTimeout(()=>{resetStreak();showModal('üí•','¬°Te pasaste!',`Llegaste a ${chCurrent} pero necesitabas ${chTarget}.\nConseguiste ${chScore}‚≠ê`,'Reintentar',chInit)},500);
      }else{
        chRenderOps();
      }
    };
    ops.appendChild(b);
  });
}

/* ============================
   4. CROSSWORD (from previous)
   ============================ */
let cwPuzzle=null,cwSel=null,cwLevel='medio',cwSize='small',cwScore=0;

function cwSetLevel(lv){
  cwLevel=lv;
  $('cw-config').querySelectorAll('.cfg-btn[data-level]').forEach(b=>b.classList.remove('active'));
  $('cw-config').querySelector(`.cfg-btn[data-level="${lv}"]`).classList.add('active');
}

function cwSetSize(sz){
  cwSize=sz;
  $('cw-config').querySelectorAll('.cfg-btn[data-size]').forEach(b=>b.classList.remove('active'));
  $('cw-config').querySelector(`.cfg-btn[data-size="${sz}"]`).classList.add('active');
}

function cwInit(){
  cwScore=0;$('cw-score').textContent='0‚≠ê';
  $('cw-config').style.display='';
  $('cw-start-btn').style.display='';
  $('cw-grid').classList.remove('playing');
  $('cw-numpad').classList.remove('playing');
  cwSel=null;
}

function cwStartGame(){
  $('cw-config').style.display='none';
  $('cw-start-btn').style.display='none';
  $('cw-grid').classList.add('playing');
  $('cw-numpad').classList.add('playing');
  cwNew();
}

// --- Crossword solver (compact) ---
function cwCountSols(eqs,gv,hid,mx,lim){
  let cnt=0;const a={...gv};
  const ord=[...hid].sort((x,y)=>eqs.filter(e=>e.includes(y)).length-eqs.filter(e=>e.includes(x)).length);
  function f(k){for(const[p,q,r]of eqs){if(k===r&&a[p]!==undefined&&a[q]!==undefined)return a[p]+a[q];if(k===p&&a[q]!==undefined&&a[r]!==undefined)return a[r]-a[q];if(k===q&&a[p]!==undefined&&a[r]!==undefined)return a[r]-a[p]}return null}
  function ok(k){for(const[p,q,r]of eqs){if(p!==k&&q!==k&&r!==k)continue;const vp=a[p],vq=a[q],vr=a[r];if(vp!==undefined&&vq!==undefined&&vr!==undefined&&vp+vq!==vr)return false;if(vp!==undefined&&vq!==undefined&&vr===undefined){if(vp+vq<1||vp+vq>mx)return false}if(vp!==undefined&&vr!==undefined&&vq===undefined){if(vr-vp<1||vr-vp>mx)return false}if(vq!==undefined&&vr!==undefined&&vp===undefined){if(vr-vq<1||vr-vq>mx)return false}}return true}
  function s(i){if(cnt>=lim)return;if(i===ord.length){for(const[p,q,r]of eqs)if(a[p]+a[q]!==a[r])return;cnt++;return}const k=ord[i],fv=f(k);if(fv!==null){if(fv>=1&&fv<=mx){a[k]=fv;if(ok(k))s(i+1);delete a[k]}return}for(let v=1;v<=mx;v++){a[k]=v;if(ok(k))s(i+1);if(cnt>=lim){delete a[k];return}}delete a[k]}
  s(0);return cnt;
}
function cwPickHidden(keys,cnt,eqs,vals,mx){
  cnt=Math.min(cnt,keys.length-1);
  for(let t=0;t<200;t++){
    const h=shuffle(keys).slice(0,cnt);const gs=new Set(keys.filter(k=>!h.includes(k)));
    let d=new Set(gs),ch=true;while(ch){ch=false;for(const eq of eqs){const u=eq.filter(c=>!d.has(c));if(u.length===1){d.add(u[0]);ch=true}}}
    if(!h.every(x=>d.has(x)))continue;
    const gv={};for(const k of keys)if(!h.includes(k))gv[k]=vals[k];
    if(cwCountSols(eqs,gv,h,mx,2)===1)return h;
  }
  return null;
}

function cwRange(){return cwLevel==='facil'?[1,6]:cwLevel==='medio'?[2,9]:[3,13]}

function cwGenSmall(){
  const[mn,mx]=cwRange();const mxV=cwLevel==='facil'?12:cwLevel==='medio'?18:26;const bl=cwLevel==='facil'?2:cwLevel==='medio'?3:4;
  for(let t=0;t<300;t++){const A=R(mn,mx),B=R(mn,mx),C=R(mn,mx),E=R(mn,mx),D=B+C,F=A+C,G=E+F;
    if([D,F,G].some(v=>v>mxV))continue;const v={A,B,C,D,E,F,G};const eq=[['B','C','D'],['E','F','G'],['A','C','F']];
    const h=cwPickHidden(Object.keys(v),bl,eq,v,mxV);if(!h)continue;
    const N=null,P={t:'op',v:'+'},Q={t:'op',v:'='};
    return{v,h,eq,mxV,g:[[N,N,{t:'n',k:'A'},N,N],[N,N,P,N,N],[{t:'n',k:'B'},P,{t:'n',k:'C'},Q,{t:'n',k:'D'}],[N,N,Q,N,N],[{t:'n',k:'E'},P,{t:'n',k:'F'},Q,{t:'n',k:'G'}]],rows:5,cols:5}}
  return cwGenSmall();
}

function cwGenMedium(){
  const[mn,mx]=cwRange();const mxV=cwLevel==='facil'?18:cwLevel==='medio'?28:38;const bl=cwLevel==='facil'?3:cwLevel==='medio'?5:7;
  for(let t=0;t<400;t++){const A=R(mn,mx),B=R(mn,mx),C=R(mn,mx),K=R(mn,mx),E=R(mn,mx),G=R(mn,mx);
    const D=B+C,F=D+E,H=A+C,J=K+E,I=G+H,L=I+J;
    const v={A,B,C,D,E,F,G,H,I,J,K,L};if(Object.values(v).some(x=>x>mxV||x<1))continue;
    const eq=[['B','C','D'],['D','E','F'],['G','H','I'],['I','J','L'],['A','C','H'],['K','E','J']];
    const h=cwPickHidden(Object.keys(v),bl,eq,v,mxV);if(!h)continue;
    const N=null,P={t:'op',v:'+'},Q={t:'op',v:'='};
    return{v,h,eq,mxV,g:[[N,N,{t:'n',k:'A'},N,N,N,{t:'n',k:'K'},N,N],[N,N,P,N,N,N,P,N,N],[{t:'n',k:'B'},P,{t:'n',k:'C'},Q,{t:'n',k:'D'},P,{t:'n',k:'E'},Q,{t:'n',k:'F'}],[N,N,Q,N,N,N,Q,N,N],[{t:'n',k:'G'},P,{t:'n',k:'H'},Q,{t:'n',k:'I'},P,{t:'n',k:'J'},Q,{t:'n',k:'L'}]],rows:5,cols:9}}
  return cwGenMedium();
}

function cwGenLarge(){
  const[mn,mx]=cwRange();const mxV=cwLevel==='facil'?24:cwLevel==='medio'?35:50;const bl=cwLevel==='facil'?5:cwLevel==='medio'?7:10;
  for(let t=0;t<500;t++){const A=R(mn,mx),B=R(mn,mx),C=R(mn,mx),K=R(mn,mx),E=R(mn,mx),G=R(mn,mx),M=R(mn,mx),_N=R(mn,mx),_P=R(mn,mx);
    const D=B+C,F=D+E,H=A+C,J=K+E,I=G+H,L=I+J,O=M+_N,Q=O+_P;
    const v={A,B,C,D,E,F,G,H,I,J,K,L,M,N:_N,O,P:_P,Q};if(Object.values(v).some(x=>x>mxV||x<1))continue;
    const eq=[['B','C','D'],['D','E','F'],['G','H','I'],['I','J','L'],['M','N','O'],['O','P','Q'],['A','C','H'],['K','E','J']];
    const h=cwPickHidden(Object.keys(v),bl,eq,v,mxV);if(!h)continue;
    const X=null,PP={t:'op',v:'+'},QQ={t:'op',v:'='};
    return{v,h,eq,mxV,g:[
      [X,X,{t:'n',k:'A'},X,X,X,{t:'n',k:'K'},X,X],
      [X,X,PP,X,X,X,PP,X,X],
      [{t:'n',k:'B'},PP,{t:'n',k:'C'},QQ,{t:'n',k:'D'},PP,{t:'n',k:'E'},QQ,{t:'n',k:'F'}],
      [X,X,QQ,X,X,X,QQ,X,X],
      [{t:'n',k:'G'},PP,{t:'n',k:'H'},QQ,{t:'n',k:'I'},PP,{t:'n',k:'J'},QQ,{t:'n',k:'L'}],
      [X,X,X,X,X,X,X,X,X],
      [{t:'n',k:'M'},PP,{t:'n',k:'N'},QQ,{t:'n',k:'O'},PP,{t:'n',k:'P'},QQ,{t:'n',k:'Q'}]
    ],rows:7,cols:9}}
  return cwGenLarge();
}

function cwNew(){
  cwSel=null;
  cwPuzzle=cwSize==='small'?cwGenSmall():cwSize==='medium'?cwGenMedium():cwGenLarge();
  cwRender();cwRenderPad();
}

function cwRender(){
  const g=$('cw-grid');g.innerHTML='';const p=cwPuzzle;
  const w=window.innerWidth;const avail=Math.min(w*.88,480);
  const sz=Math.max(26,Math.min(Math.floor((avail-(p.cols-1)*2)/p.cols),52));
  const fs=sz<34?'.8rem':sz<42?'1rem':sz<50?'1.2rem':'1.35rem';
  g.style.gridTemplateColumns=`repeat(${p.cols},${sz}px)`;g.style.gridTemplateRows=`repeat(${p.rows},${sz}px)`;
  for(let r=0;r<p.rows;r++){for(let c=0;c<p.cols;c++){
    const cd=p.g[r][c];const d=document.createElement('div');d.className='cw-cell';d.style.cssText=`width:${sz}px;height:${sz}px;font-size:${fs}`;
    if(!cd)d.classList.add('empty');
    else if(cd.t==='op'){d.classList.add('op');d.textContent=cd.v}
    else if(p.h.includes(cd.k)){d.classList.add('inp');d.dataset.key=cd.k;d.onclick=()=>{document.querySelectorAll('.cw-cell.inp').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');cwSel=d}}
    else{d.classList.add('num');d.textContent=p.v[cd.k]}
    g.appendChild(d);
  }}
  const first=g.querySelector('.cw-cell.inp');if(first){first.classList.add('sel');cwSel=first}
}

function cwRenderPad(){
  const np=$('cw-numpad');np.innerHTML='';const mx=cwPuzzle.mxV;
  const pr=mx<=10?5:mx<=18?6:6;np.style.gridTemplateColumns=`repeat(${pr},1fr)`;
  for(let i=1;i<=mx;i++){const b=document.createElement('button');b.textContent=i;b.onclick=()=>cwEnter(i);np.appendChild(b)}
  const d=document.createElement('button');d.textContent='‚å´';d.className='cwdel';d.onclick=()=>cwEnter(null);np.appendChild(d);
  const ch=document.createElement('button');ch.textContent='‚úì Comprobar';ch.className='cwchk';ch.style.gridColumn=`span ${Math.min(pr-1,3)}`;ch.onclick=cwCheck;np.appendChild(ch);
}

function cwEnter(n){
  if(!cwSel)return;
  if(n===null){cwSel.textContent='';cwSel.classList.remove('filled','ok','bad');return}
  cwSel.textContent=n;cwSel.classList.add('filled');cwSel.classList.remove('ok','bad');
  const ins=[...document.querySelectorAll('.cw-cell.inp')];const i=ins.indexOf(cwSel);
  for(let j=1;j<=ins.length;j++){const nx=ins[(i+j)%ins.length];if(!nx.textContent){document.querySelectorAll('.cw-cell.inp').forEach(x=>x.classList.remove('sel'));nx.classList.add('sel');cwSel=nx;return}}
}

function cwCheck(){
  const ins=document.querySelectorAll('.cw-cell.inp');let full=true;
  const cv={};for(const k of Object.keys(cwPuzzle.v))if(!cwPuzzle.h.includes(k))cv[k]=cwPuzzle.v[k];
  ins.forEach(c=>{if(!c.textContent){full=false;return}cv[c.dataset.key]=parseInt(c.textContent)});
  if(!full)return;
  let allOk=true;const bad=new Set();
  for(const[a,b,c]of cwPuzzle.eq){if(cv[a]+cv[b]!==cv[c]){allOk=false;[a,b,c].filter(x=>cwPuzzle.h.includes(x)).forEach(x=>bad.add(x))}}
  ins.forEach(c=>{if(bad.has(c.dataset.key)){c.classList.add('bad');c.classList.remove('ok')}else{c.classList.add('ok');c.classList.remove('bad')}});
  if(allOk){cwScore++;$('cw-score').textContent=cwScore+'‚≠ê';addStars(1);confetti();showModal('üî¢','¬°Crucigrama resuelto!',`+1‚≠ê`,'Siguiente',cwNew)}
  else resetStreak();
}

function cwHint(){
  const ins=[...document.querySelectorAll('.cw-cell.inp')].filter(c=>!c.textContent||c.classList.contains('bad'));
  if(!ins.length)return;const c=ins[R(0,ins.length-1)];c.textContent=cwPuzzle.v[c.dataset.key];c.classList.add('filled','ok');c.classList.remove('bad');
}

/* ============================
   5. EQUATION BUILDER
   ============================ */
let eqbTarget=0,eqbNums=[],eqbOps=[],eqbWorkspace=[],eqbScore=0;

function eqbInit(){eqbScore=0;$('eqb-score').textContent='0‚≠ê';eqbNew()}

function eqbNew(){
  // Generate: pick 3-4 numbers and 2-3 ops that can make a target
  const a=R(1,9),b=R(1,9),op=R(0,1)?'+':'-';
  const res=op==='+'?a+b:a-b;
  const c=R(1,9),op2=R(0,1)?'+':'√ó';
  const target=op2==='+'?res+c:res*c;
  
  eqbTarget=target;eqbNums=[a,b,c];eqbOps=[op,op2];eqbWorkspace=[];
  $('eqb-target').textContent=target;
  eqbRender();
}

function eqbRender(){
  const ws=$('eqb-workspace');ws.innerHTML='';
  if(eqbWorkspace.length===0){ws.innerHTML='<span style="color:var(--muted);font-size:.85rem">Pulsa las piezas para construir</span>'}
  else{eqbWorkspace.forEach((item,i)=>{
    const d=document.createElement('div');d.className='eq-slot '+(item.type==='num'?'num-slot':'op-slot');d.textContent=item.val;
    d.onclick=()=>{eqbWorkspace.splice(i,1);eqbRender()};ws.appendChild(d);
  })}

  const pc=$('eqb-pieces');pc.innerHTML='';
  eqbNums.forEach((n,i)=>{
    const used=eqbWorkspace.filter(w=>w.type==='num'&&w.srcIdx===i).length>0;
    const d=document.createElement('div');d.className='eq-piece num-piece'+(used?' used':'');d.textContent=n;
    d.onclick=()=>{if(!used){eqbWorkspace.push({type:'num',val:n,srcIdx:i});eqbRender()}};pc.appendChild(d);
  });
  eqbOps.forEach((o,i)=>{
    const used=eqbWorkspace.filter(w=>w.type==='op'&&w.srcIdx===i).length>0;
    const d=document.createElement('div');d.className='eq-piece op-piece'+(used?' used':'');d.textContent=o;
    d.onclick=()=>{if(!used){eqbWorkspace.push({type:'op',val:o,srcIdx:i});eqbRender()}};pc.appendChild(d);
  });
}

function eqbClear(){eqbWorkspace=[];eqbRender()}

function eqbCheck(){
  if(eqbWorkspace.length<3)return;
  // Evaluate left to right
  const tokens=eqbWorkspace.map(w=>w.val);
  let result=null;
  try{
    result=Number(tokens[0]);
    for(let i=1;i<tokens.length-1;i+=2){
      const op=tokens[i],next=Number(tokens[i+1]);
      if(isNaN(next))throw 0;
      if(op==='+')result+=next;else if(op==='-')result-=next;else if(op==='√ó')result*=next;else throw 0;
    }
  }catch(e){result=null}
  if(result===eqbTarget){eqbScore++;$('eqb-score').textContent=eqbScore+'‚≠ê';addStars(1);confetti();showModal('üß©','¬°Ecuaci√≥n correcta!',`${tokens.join(' ')} = ${eqbTarget}\n+1‚≠ê`,'Siguiente',eqbNew)}
  else{resetStreak();showModal('ü§î','No es correcto',result!==null?`${tokens.join(' ')} = ${result}, pero necesitas ${eqbTarget}`:'Revisa tu ecuaci√≥n','Reintentar',()=>{})}
}

function eqbSkip(){eqbNew()}

/* ============================
   6. NUMBER GUESS
   ============================ */
let ngSecret=0,ngLo=1,ngHi=50,ngTries=0,ngScore=0,ngMaxTries=7;

function ngInit(){ngScore=0;$('ng-score').textContent='0‚≠ê';ngNewRound()}

function ngNewRound(){
  ngLo=1;ngHi=R(0,1)?50:100;ngSecret=R(ngLo,ngHi);ngTries=0;ngMaxTries=ngHi<=50?7:8;
  $('ng-lo').textContent=ngLo;$('ng-hi').textContent=ngHi;
  $('ng-fb').textContent=`Tienes ${ngMaxTries} intentos`;$('ng-fb').style.color='var(--muted)';
  $('ng-tries').innerHTML='';$('ng-input').value='';$('ng-input').max=ngHi;
}

function ngGuess(){
  const v=parseInt($('ng-input').value);$('ng-input').value='';
  if(isNaN(v)||v<1||v>ngHi)return;
  ngTries++;
  const d=document.createElement('span');d.className='ng-try';d.textContent=v;
  if(v===ngSecret){
    d.style.background='rgba(52,211,153,.2)';d.style.color='var(--green)';$('ng-tries').appendChild(d);
    const earned=Math.max(1,ngMaxTries-ngTries+1);ngScore+=earned;$('ng-score').textContent=ngScore+'‚≠ê';
    addStars(earned);confetti();
    showModal('üéØ','¬°Adivinaste!',`El n√∫mero era ${ngSecret}.\nLo encontraste en ${ngTries} intentos.\n+${earned}‚≠ê`,'Siguiente',ngNewRound);
  }else if(v<ngSecret){
    d.classList.add('lo');$('ng-tries').appendChild(d);
    $('ng-fb').textContent='‚¨ÜÔ∏è ¬°M√°s alto!';$('ng-fb').style.color='var(--blue)';
    ngLo=Math.max(ngLo,v+1);$('ng-lo').textContent=ngLo;
  }else{
    d.classList.add('hi');$('ng-tries').appendChild(d);
    $('ng-fb').textContent='‚¨áÔ∏è ¬°M√°s bajo!';$('ng-fb').style.color='var(--red)';
    ngHi=Math.min(ngHi,v-1);$('ng-hi').textContent=ngHi;
  }
  if(ngTries>=ngMaxTries&&v!==ngSecret){resetStreak();showModal('üòÖ','¬°Se acabaron los intentos!',`El n√∫mero era ${ngSecret}.`,'Reintentar',ngNewRound)}
  $('ng-input').focus();
}

$('ng-input').addEventListener('keydown',e=>{if(e.key==='Enter')ngGuess()});

</script>
</body>
</html>
